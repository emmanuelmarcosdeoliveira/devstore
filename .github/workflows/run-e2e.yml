name: E2E Tests

on: [push, pull_request]

jobs:
  cypress-run:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Faz o checkout do c√≥digo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Instala o pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      # 3Ô∏è‚É£ Instala Node.js com cache do pnpm
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      # 4Ô∏è‚É£ Instala depend√™ncias
      - name: Install dependencies
        run: pnpm install

      # 5Ô∏è‚É£ Cache do bin√°rio do Cypress
      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}

      # 6Ô∏è‚É£ Instala bin√°rio do Cypress
      - name: Install Cypress binary
        run: pnpm cypress install

      # 7Ô∏è‚É£ Build do projeto ‚Äî agora com as vari√°veis definidas
      - name: Build project
        run: pnpm build
        env:
          NODE_ENV: production
          APP_URL: 'http://localhost:3000'
          NEXT_PUBLIC_API_BASE_URL: 'https://devstore-api-lilac.vercel.app/'

      # 8Ô∏è‚É£ Inicia o servidor em segundo plano
      - name: Start Next.js server
        run: pnpm start &
        env:
          NODE_ENV: production
          APP_URL: 'http://localhost:3000'
          NEXT_PUBLIC_API_BASE_URL: 'https://devstore-api-lilac.vercel.app/'

      # 9Ô∏è‚É£ Aguarda o servidor estar dispon√≠vel
      - name: Wait for server to be ready
        run: npx wait-on http://localhost:3000

      # üîü Executa os testes E2E
      - name: Run Cypress tests
        run: pnpm cypress run
        env:
          APP_URL: 'http://localhost:3000'
          NEXT_PUBLIC_API_BASE_URL: 'https://devstore-api-lilac.vercel.app/'
